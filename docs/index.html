<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Relive your old tweets</title>
    <meta name="description"content="Find your Tweets on this day in the past.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://oldtweets.today/">
    <meta property="og:title" content="See what you've Tweeted on this day in the past.">
    <meta property="og:description" content="Relive your old tweets from years past">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary">
    <meta property="twitter:url" content="http://oldtweets.today/">
    <meta property="twitter:title" content="Relive your old tweets from years past">
    <meta property="twitter:description" content="Find your Tweets on this day in the past.">

    <link rel="icon" href="favicon.ico" type="image/x-icon" />

    <style>
        body {
            background: url(trianglify.png);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', Calibri, sans-serif;
            padding: 20px;
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        h1 {
            padding-bottom: 6px;
        }

        #username-input {
            height: 1.9rem;
            background: none;
            padding: 0.125rem 0.5rem;
            width: 50%;
            outline: none;
            /* A Twitter-y colour border: 2px solid #3B94D9; */
            border: 2px solid darkblue;
            -webkit-transition: all 0.28s ease;
            transition: all 0.28s ease;
            border-top-left-radius: 5px;
            border-bottom-left-radius: 5px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', Calibri, sans-serif
        }

        #submit-button {
            background-color: darkblue;
            color: white;
            line-height: 2;
            height: 1.9rem;
            padding: 0.125rem 1rem;
            border-top-right-radius: 5px;
            border-bottom-right-radius: 5px;
            border: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', Calibri, sans-serif
        }

        #loading-indicator {
            font-size: 1.8rem;
            padding: 20px;
            display: none;
        }

        #tweets-container {
            padding-top: 10px;
            display: none;
        }

        #help-text{
            padding-top: 5px;
        }

    </style>
</head>

<body>
<h1>See what you've Tweeted on this day in the past.</h1>
<form onsubmit="handleFormSubmit(event);">
    <input id="username-input" type="text" name="username" placeholder="Your Twitter username" required>
    <button id="submit-button" type="submit">Show me</button>
    <div id="help-text"><small>If your profile is protectedüîí, you'll need to <a href="https://twitter.com/settings/safety">unlock it first.</a></small></div>
</form>
<small>Developerüíª? <a href="//github.com/shalvah/oldtweets.today">Check out the source code üëÄ</a></small>

<div id="loading-indicator"></div>
<div id="tweets-container"></div>
<script>
    // prefill the value if the user is coming from a direct link
    let hash = window.location.hash.split('#')[1];
    if (hash != '') {
        document.querySelector('input[name="username"]').value = hash;
    } else {
        // or try query string
        let queryString = window.location.search;
        let queryParams = new URLSearchParams(queryString);
        if (queryParams.get('username')) {
            document.querySelector('input[name="username"]').value = queryParams.get('username');
        }
    }
</script>

<script>
    var loadingIndicator = document.querySelector('#loading-indicator');
    var submitButton = document.querySelector('#submit-button');

    function showLoadingIndicator() {
        submitButton.disabled = true;
        loadThatShit();
    }

    function doneWithLoading() {
        clearInterval(window.loaderInterval);
        loadingIndicator.innerText = "Done! ‚úÖ";
        setTimeout(() => {
            loadingIndicator.style.display = 'none';
            submitButton.removeAttribute('disabled');
            window['tweets-container'].style.display = 'block';
        }, 500);
    }

    function loadThatShit() {
        loadingIndicator.innerText = `Fetching your tweets from ${day}...just a sec`;
        loadingIndicator.style.display = 'block';
        emojiLoad();
    }

    function emojiLoad() {
        window.loaderInterval = setInterval(() => {
            let emojis = ['ü§î', 'üìù', 'üë©‚Äçüè≠', 'ü§ó', 'üôà', 'üò∏', 'üôÇ'];
            loadingIndicator.innerText = `Fetching your tweets from ${day}...just a sec ${emojis[Math.floor(Math.random() * emojis.length)]}`;
        }, 750);
    }
</script>
<script>
    /**
     * @param {Event} event
     */
    function handleFormSubmit(event) {
        event.preventDefault();
        let username = event.target.querySelector('input[name="username"]').value;
        history.pushState({ username }, '', '#' + username);
        window.day = (new Date).toLocaleString('en-us', { month: 'long', day: 'numeric' });
        showLoadingIndicator(day);
        // get rid of any existing content
        window['tweets-container'].innerHTML = '';
        username = username.trim();
        getTweetsOnThisDay(username)
            .then(tweets => {
                let tweetsHtml = [];
                let hasContent = false;
                for (let year of Object.keys(tweets).reverse()) {
                    if (tweets[year].length) {
                        hasContent = true;
                        tweetsHtml.push(`<div>`);
                        tweetsHtml.push(`<h3>${year}</h3>`);
                        tweetsHtml.push(tweets[year].join("\n"));
                        tweetsHtml.push("</div><br>");
                    }
                }

                if (!hasContent) {
                    throw `Sorry, we couldn't find any tweets by <b>@${username}</b> on <b>${day}</b>üòï`;
                }
                injectContentIntoPage(tweetsHtml.join("\n"), true);
                document.title = `@${username.replace("@", "")}'s old Tweets`;
            })
            // Use a timeout to allow the Twitter library hydrate the tweet DOM elements
            .then(() => setTimeout(doneWithLoading, 2000))
            .catch(showError);
    }

    /**
     * @param {string} username
     */
    function getTweetsOnThisDay(username) {
        const utcOffset = (new Date()).getTimezoneOffset();
        const apiUrl = `https://europe-west1-tweetedonthisday.cloudfunctions.net/getTweetsOnThisDay?username=${username}&utcOffset=${utcOffset}`;
        return fetch(apiUrl).then(r => r.json())
            .then(r => {
                if (r.error) {
                    console.log(r.error);
                    throw 'Something went wrong. Please try again.üò≠';
                }
                return r;
            })
            .catch(r => {
                if (r.error) {
                    console.log(r.error);
                }
                throw 'Something went wrong. Please try again.üò≠';
            })
    }

    /**
     * @param {string} content
     * @param {boolean} isTwitterResponse
     */
    function injectContentIntoPage(content) {
        let container = document.getElementById('tweets-container');
        container.innerHTML = content;
        twttr.widgets.load(container);
    }

    function showError(message) {
        doneWithLoading();
        setTimeout(() => {
            loadingIndicator.innerHTML = message;
            loadingIndicator.style.display = 'block';
        }, 1000);
    }
</script>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</body>
